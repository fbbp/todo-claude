# データベースインデックス最適化

このドキュメントでは、Todo アプリケーションのデータベースインデックス設計について説明します。

## インデックス設計の原則

1. **最も頻繁に使用されるクエリ** に最適化されたインデックスを作成する
2. **複合インデックス** は左端から右の順で使用される（左端の列が条件にない場合、そのインデックスは使用されない）
3. **多値インデックス** (マルチエントリインデックス) はサブオブジェクトや配列のインデクシングに使用する

## テーブルとインデックス

### `tasks` テーブル

```javascript
tasks: 'id, status, dueAt, categoryId, [status+dueAt], [categoryId+status], createdAt, repeatParentId, updatedAt, *checklist'
```

| インデックス | 用途 | ユースケース |
|------------|------|------------|
| `id` | プライマリキー | タスクの直接取得 |
| `status` | タスクのステータスでフィルタリング | 完了/未完了/アーカイブタスクの取得 |
| `dueAt` | 期限によるフィルタリング | 特定の日付のタスク取得 |
| `categoryId` | カテゴリによるフィルタリング | 特定カテゴリのタスク取得 |
| `[status+dueAt]` | ステータスと期限の複合フィルタリング | 期限切れの未完了タスク、今週の完了タスクなど |
| `[categoryId+status]` | カテゴリとステータスの複合フィルタリング | 特定カテゴリの未完了タスクなど |
| `createdAt` | 作成日時による並べ替え | 最近作成されたタスクの表示 |
| `repeatParentId` | 繰り返しタスクの親と子の関連付け | タスクの繰り返しインスタンスを取得 |
| `updatedAt` | 更新日時による並べ替え | 最近更新されたタスクの表示 |
| `*checklist` | チェックリスト項目の検索 | チェックリスト項目によるタスク検索 (マルチエントリインデックス) |

#### 主要なクエリパターン

1. **ステータス別のタスク取得**: `db.tasks.where('status').equals('pending')`
2. **期限別のタスク取得**: `db.tasks.where('dueAt').between(startDate, endDate)`
3. **カテゴリ別のタスク取得**: `db.tasks.where('categoryId').equals(categoryId)`
4. **ステータスと期限の複合条件**: `db.tasks.where('[status+dueAt]').between(['pending', now], ['pending', futureDate])`
5. **カテゴリとステータスの複合条件**: `db.tasks.where('[categoryId+status]').equals([categoryId, 'pending'])`
6. **子タスクの取得**: `db.tasks.where('repeatParentId').equals(parentId)`

### `categories` テーブル

```javascript
categories: 'id, order, name, color'
```

| インデックス | 用途 | ユースケース |
|------------|------|------------|
| `id` | プライマリキー | カテゴリの直接取得 |
| `order` | 表示順序 | 並べ替えられたカテゴリリストの表示 |
| `name` | カテゴリ名での検索 | 名前による検索、名前の重複チェック |
| `color` | 色でのフィルタリング | 特定の色のカテゴリの取得 (表示テーマ対応など) |

#### 主要なクエリパターン

1. **順序付きカテゴリの取得**: `db.categories.orderBy('order')`
2. **カテゴリ名での検索**: `db.categories.where('name').equals(name)`

### `settings` テーブル

```javascript
settings: 'key, value'
```

| インデックス | 用途 | ユースケース |
|------------|------|------------|
| `key` | プライマリキー | 設定の直接取得 |
| `value` | 値によるフィルタリング | 特定の値を持つ設定の検索 |

#### 主要なクエリパターン

1. **設定の取得**: `db.settings.get(key)`
2. **特定の値を持つ設定の検索**: `db.settings.where('value').equals(someValue)`

## 最適化ポイント

1. **複合インデックス**: 最も頻繁に使用される条件の組み合わせに対してのみ作成
2. **マルチエントリインデックス**: チェックリスト項目のように配列内の各要素をインデックス化する場合に使用
3. **クエリパターンの分析**: アプリケーションの実際の使用パターンに基づき定期的に見直し

## パフォーマンス向上のための推奨事項

1. **範囲検索の最適化**: 日付範囲検索など、範囲条件が含まれるクエリには `between` を使用
2. **適切な複合キーの順序**: 最も絞り込み効果の高い列を複合インデックスの左側に配置
3. **不要なインデックスの削除**: 使用されていないインデックスは削除してストレージを節約
4. **大量データの分割取得**: 結果セットが大きい場合は `limit()` と `offset()` を使用

## 将来の最適化の可能性

1. **全文検索**: タスクのタイトルやメモの全文検索機能を追加する場合は専用インデックスを検討
2. **時間ベースのパーティショニング**: 大量のタスクデータがある場合、古いタスクを別テーブルに移動することを検討
3. **動的インデックス**: ユーザーの使用パターンに基づいて動的にインデックスを最適化する仕組み